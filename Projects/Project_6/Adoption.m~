function Adoption
global Parent Tree Active EdgeCaps Edges Edge_Lens r c Orphans Orphan_cnt PLengths
while Orphan_cnt
    p=Orphans(Orphan_cnt);
    Orphan_cnt=Orphan_cnt-1;
    neibs=[Edges(p,1:Edge_Lens(p)) r*c+1 r*c+2];
    for i=1:length(neibs)
        % modify Plengths
        q=neibs(i);
        
        % check if path to tree exists
        current_node=q;
        while Parent(current_node)~=0
            current_node=Parent(current_node);
        end
        if current_node>r*c
            path2tree=1;
        else
            path2tree=0;
        end
        % get capacity
        if q<=r*c
            np=min(p,q);
            nq=max(p,q);
            cap=EdgeCaps(np,Edges(np,1:Edge_Lens(np))==nq);
        else
            if q==r*c+1
                cap=EdgeCaps(p,5);
            end
            if q==r*c+2
                cap=EdgeCaps(p,6);
            end
        end
        
        if Tree(p)==Tree(q) && cap>0 && path2tree
            Parent(p)=q;
            break
            % Active() state of p remains unchanged
        end
        
    end
    if Parent(p)==0 % no valid neighbours
        neibs=Edges(p,1:Edge_Lens(p));
        for i=1:length(neibs)
            q=neibs(i);
            
            if Tree(p)==Tree(q)
                np=min(p,q);
                nq=max(p,q);
                if EdgeCaps(np,Edges(np,1:Edge_Lens(np))==nq)>0 && Tree(q)~=0
                    FIFOInsert(q)
                    Active(q)=1;
                end
            end
            if Parent(q)==p
                Orphan_cnt=Orphan_cnt+1;
                Orphans(Orphan_cnt)=q;
                Parent(q)=0;
            end
        end
        Tree(p)=0;
        Active(p)=0;
        Parent(p)=0;
    end
end
